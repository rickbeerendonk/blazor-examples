@page "/schema-dictionary"
@inject FormSchemaService Schema

<PageTitle>Schema + Dictionary</PageTitle>

<h1>1. Schema + Dictionary</h1>
<p>Fields are rendered from a runtime schema to a dictionary model.</p>

@if (fields is null)
{
    <p>Loadingâ€¦</p>
}
else
{
    <EditForm EditContext="editContext" OnValidSubmit="HandleValidSubmit">
        <ValidationSummary class="validation-summary" />

        <fieldset>
            <legend>Customer</legend>
            @foreach (var field in fields)
            {
                <DynamicFieldRenderer TValue="object" Field="field" Model="formData" />
            }
        </fieldset>

    <button type="submit">Submit</button>
    </EditForm>

    @if (submitted is not null)
    {
    <h3>Result</h3>
        <pre>@submitted</pre>
    }
}

@code {
    private IReadOnlyList<DynamicForms.Models.DynamicField>? fields;
    private Dictionary<string, object?> formData = new();
    private EditContext? editContext;
    private ValidationMessageStore? messages;
    private string? submitted;

    protected override async Task OnInitializedAsync()
    {
        fields = await Schema.GetCustomerFormAsync();
        editContext = new EditContext(formData);
        messages = new ValidationMessageStore(editContext);
        editContext.OnValidationRequested += (_, __) => Validate();
        editContext.OnFieldChanged += (_, __) => Validate();
    }

    private void Validate()
    {
        if (editContext is null || messages is null || fields is null) return;
        messages.Clear();

        foreach (var f in fields)
        {
            if (!f.Required) continue;
            var val = formData.TryGetValue(f.Property, out var v) ? v : null;
            var isEmpty = val is null || (val is string s && string.IsNullOrWhiteSpace(s));
            if (isEmpty)
            {
                messages.Add(new FieldIdentifier(formData, f.Property), $"{f.Label} is required.");
            }
        }
        editContext.NotifyValidationStateChanged();
    }

    private void HandleValidSubmit()
    {
        Validate();
        if (editContext is null) return;
        if (!editContext.GetValidationMessages().Any())
        {
            submitted = System.Text.Json.JsonSerializer.Serialize(formData, new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true
            });
        }
    }
}
