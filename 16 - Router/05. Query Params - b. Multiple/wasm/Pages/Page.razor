<!-- European Union Public License version 1.2 -->
<!-- Copyright © 2021 Rick Beerendonk -->

@* /page?tag=csharp&tag=blazor *@
@page "/page"

@inject NavigationManager NavManager

<h2>Page @Id.ToString() with Multiple Tags</h2>

@foreach (var tag in availableTags)
{
    <div>
        <label>
            <input type="checkbox"
                   checked="@selectedTags.Contains(tag)"
                   @onchange="@((e) => OnTagChanged(tag, (bool)e.Value!))" />
            @tag
        </label>
    </div>
}

<p>
    @foreach (var tag in selectedTags) { <code>@tag</code> }
</p>

<h3>Current URL:</h3>
<p><code>@NavManager.Uri</code></p>

@code {
    // Bind to ?id=...
    [SupplyParameterFromQuery]
    public int Id { get; set; }

    // Bind to ?tag=...&tag=...
    [SupplyParameterFromQuery(Name = "tag")]
    public string[]? Tags { get; set; }

    private readonly string[] availableTags = [ "csharp", "blazor", "razor", "aspnet" ];
    private HashSet<string> selectedTags = new(StringComparer.OrdinalIgnoreCase);

    protected override void OnParametersSet()
    {
        // Sync set from query params on load/navigation
        selectedTags = new HashSet<string>(Tags ?? Array.Empty<string>(), StringComparer.OrdinalIgnoreCase);
    }

    private void OnTagChanged(string tag, bool isChecked)
    {
        if (isChecked)
        {
            selectedTags.Add(tag);
        }
        else
        {
            selectedTags.Remove(tag);
        }

        UpdateUrl();
    }

    private void UpdateUrl()
    {
        var uri = NavManager.GetUriWithQueryParameters(new Dictionary<string, object?>
        {
            ["tag"] = selectedTags.Any() ? selectedTags.ToArray() : null
        });

        // Update URL without recreating the component
        NavManager.NavigateTo(uri, replace: true);
    }
}